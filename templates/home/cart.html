{% extends "base/base.html" %}

{% block title %}Home {% endblock %}

{% block css %}
<link rel="stylesheet" href="/static/CSS/cart.css">
{% endblock css%}

{% block body %}
{% include "base/nav.html" %}

<!-- if carts is empty  -->
{% if error %}
<div class="container-fluid  mt-5">
  <div class="row">
   <div class="col-md-12">
         <div class="col-sm-12  text-center">
           <img src="https://i.imgur.com/dCdflKN.png" width="130" height="130" class="img-fluid mb-4 mr-3">
           <h3><strong>{{error}}!</strong></h3>
           <a href="#" class="btn btn-dark mt-2" data-abc="true">Continue shopping</a>
         </div>
   </div>
  </div>
 </div>
{% else %}


<!-- user is add the items into carts  -->
<div class="container mt-3">
  <div class="container">
    <div class="row ">
      <div class="card col-8">
        <div class="container">
          <table class="table" style="width: 650px;">
            <thead>
              <tr>
                <th scope="col"></th>
                <th scope="col">Quantity</th>
                <th scope="col">Price</th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody>
              <!-- show the customer items -->
              {% for i in cart_items %}
              <tr>
                <td>
                  <img src="/media/{{i.food.img}}" alt="..." width="60px" height="60px">
                  {{i.food.food_name}}
                </td>
                <td>1</td>
                <td>{{i.food.price}}</td>
                <td><a href="{% url 'remove' i.uid %}"><button class="btn btn-dark">Remove</button></a></td>

              </tr>

              {% endfor %}
            </tbody>
          </table>

          <div class="bottem mb-4">
            <a href=""><button class="btn btn-outline-dark"> <b><i class='fas fa-less-than'></i> Continue
                  shopping</b></button></a>
          </div>
        </div>
      </div>
      <div class="col-4">
        <div class="card p-3">
          {% include "base/alert.html" %}
          <p>Have coupon?</p>
          <form action="" method="post">
            {% csrf_token %}
            <div class="method input-group mb-3">

              <input type="text" class="form-control" placeholder="Coupon code" name="Coupon_code">
              <div class="input-group-append">
                <button class="btn btn-dark" type="submit">Apply</button>
              </div>

            </div>
          </form>
         <small class="text-success">You applied <b>{{cart_obj.coupon.coupon_code}}</b> </small> 
        </div>

        <div class="card p-3 mt-3">
          <h5>Price Details</h5>
          <div class="d-flex justify-content-between align-items-center">
            {% if cart_obj.coupon and totals.food__price__sum >= cart_obj.coupon.min_amount   %}
            {% load mathfilters %}
            <div class="summary">
              <p>Price()</p>
              <p>coupon applied</p>
              <p>Delivery Charges</p>
            </div>
            <div class="total">
              <p>₹{{totals.food__price__sum}}</p>
              <p class="text-success">-₹{{cart_obj.coupon.discount}}</p>
              <p>₹0</p>
            </div>
          </div>
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            <h6>Total Amount</h6>
            <h6>₹{{totals.food__price__sum|sub:cart_obj.coupon.discount}}</h6>
          </div>
          <div class="d-grid gap-2 mt-2">
            <button class="btn btn-dark" type="submit" id="rzp-button1">CHECK OUT</button>
          </div>
         {% else %}
          <div class="d-flex justify-content-between align-items-center">
              <div class="summary">
                  <p>Price()</p>
                  <p>coupon applied</p>
                  <p>Delivery Charges</p>
              </div>
              <div class="total">
                  <p>₹{{totals.food__price__sum}}</p>
                  <p class="text-success">-₹{{cart_obj.coupon.discount}}</p>
                  <p>₹0</p>
              </div>
          </div>
        </div>
        <hr>
          <div class="d-flex justify-content-between align-items-center">
            <h6>Total Amount</h6>
            <h6>₹{{totals.food__price__sum}}</h6>
          </div>
          <div class="d-grid gap-2 mt-2">
           <button class="btn btn-dark" type="submit" id="rzp-button1">CHECK OUT</button>
          </div>
          {% endif %}
          </div>
         </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  var options = {
      "key": "rzp_test_pxJNNIHcr3CxZ6",
      "amount": "{{totals.food__price__sum}}", 
      "currency": "INR",
      "name": "Project 8 Sem",
      "description": "Test Transaction",
      "image": "/static/images/bg-3.jpg",
      "order_id": "{{payment.id}}", //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
      "handler": function (response){
          var paymentId = response.razorpay_payment_id;
          window.location.href="{% url 'success' %}?order_id={{payment.id}}&amount={{totals.food__price__sum}}&payment_id="+paymentId
      },
      "theme": {
        "color": "#36454F"
          // "color": "#3399cc"
      }
  };
  var rzp1 = new Razorpay(options);
  rzp1.on('payment.failed', function (response){
          alert(response.error.code);
          alert(response.error.description);
          alert(response.error.source);
          alert(response.error.step);
          alert(response.error.reason);
          alert(response.error.metadata.order_id);
          alert(response.error.metadata.payment_id);
  });
  document.getElementById('rzp-button1').onclick = function(e){
      rzp1.open();
      e.preventDefault();
  }
  </script>
{% endblock body%}